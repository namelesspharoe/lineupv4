# Messaging System Documentation

## Overview
The messaging system provides real-time chat functionality between users in the lesson booking application. It supports text messages, file attachments, and message reactions.

## Components

### MessageList
- Displays all conversations for the current user
- Shows unread message counts
- Provides search and filtering functionality
- Includes a "+" button to start new conversations

### ChatWindow
- Real-time chat interface for individual conversations
- Supports text messages and file attachments
- Shows message status (sent, delivered, read)
- Includes message reactions and reply functionality

### NewConversationModal
- Modal for starting new conversations
- Shows available users (excluding those already in conversations)
- Search functionality to find specific users

## Key Features

### Real-time Messaging
- Uses Firestore real-time listeners for instant message updates
- Fallback to polling if real-time fails due to permissions
- Automatic message status updates

### Conversation Management
- Automatic conversation grouping by user pairs
- Conversation ID generation using sorted user IDs
- Unread message tracking and marking as read

### User Interface
- Modern, responsive design with Tailwind CSS
- Loading states and error handling
- Search and filter functionality
- Message status indicators

## Database Structure

### Messages Collection
```typescript
interface Message {
  id: string;
  senderId: string;
  receiverId: string;
  content: string;
  timestamp: string;
  read: boolean;
  status: 'sending' | 'sent' | 'delivered' | 'read' | 'failed';
  messageType: 'text' | 'image' | 'file' | 'system';
  attachments?: MessageAttachment[];
  reactions?: MessageReaction[];
  replyTo?: string;
  conversationId: string; // Generated from sorted user IDs
  createdAt?: string;
  updatedAt?: string;
}
```

### Conversation ID Generation
Conversation IDs are generated by sorting user IDs and joining them with an underscore:
```typescript
const conversationId = [userId1, userId2].sort().join('_');
```

## API Functions

### Core Functions
- `getMessages(userId)` - Get all messages for a user
- `sendMessage(senderId, receiverId, content)` - Send a new message
- `subscribeToMessages(userId, callback)` - Real-time message subscription
- `subscribeToConversation(userId1, userId2, callback)` - Real-time conversation subscription

### Conversation Management
- `createConversation(senderId, receiverId, initialMessage)` - Start a new conversation
- `conversationExists(userId1, userId2)` - Check if conversation exists
- `getAvailableUsers(currentUserId)` - Get users available for new conversations

### Message Actions
- `markMessageAsRead(messageId)` - Mark message as read
- `markConversationAsRead(userId1, userId2)` - Mark all messages in conversation as read
- `addReaction(messageId, userId, emoji)` - Add reaction to message
- `removeReaction(messageId, userId, emoji)` - Remove reaction from message
- `deleteMessage(messageId)` - Delete a message

## Usage Examples

### Starting a New Conversation
```typescript
import { createConversation } from '../services/messages';

const messageId = await createConversation(
  currentUserId,
  otherUserId,
  "Hello! I'd like to start a conversation."
);
```

### Sending a Message
```typescript
import { sendMessage } from '../services/messages';

const messageId = await sendMessage(
  senderId,
  receiverId,
  "Hello there!",
  'text'
);
```

### Real-time Message Listening
```typescript
import { subscribeToMessages } from '../services/messages';

const unsubscribe = subscribeToMessages(userId, (messages) => {
  // Handle new messages
  console.log('New messages:', messages);
});

// Clean up when done
unsubscribe();
```

## Error Handling

The system includes comprehensive error handling:
- Permission errors are handled gracefully with fallback methods
- Network errors are caught and logged
- UI shows appropriate error messages to users
- Real-time subscriptions fall back to polling if needed

## Security

- All Firestore rules require authentication
- Users can only access messages they're involved in
- File uploads are restricted to authenticated users
- Message content is validated before sending

## Testing

Use the `MessageTest` component to verify system functionality:
```typescript
import { MessageTest } from '../components/messages/MessageTest';

// Add to any page for testing
<MessageTest />
```

## Troubleshooting

### Common Issues
1. **Real-time not working**: Check Firestore permissions and network connection
2. **Messages not loading**: Verify user authentication and Firestore rules
3. **File uploads failing**: Check storage permissions and file size limits

### Debug Mode
Enable console logging to debug issues:
```typescript
// Add to browser console
localStorage.setItem('debug', 'messages');
```

## Future Enhancements

- Group conversations
- Message encryption
- Push notifications
- Message threading
- Rich text formatting
- Voice messages
- Video calls integration
